{
    "properties": {
        "displayName": "Kubernetes cluster pods and containers should only use allowed SELinux options",
        "policyType": "BuiltIn",
        "mode": "Microsoft.Kubernetes.Data",
        "description": "This policy ensures pods and containers only use allowed SELinux options in a Kubernetes cluster. This policy is generally available for Kubernetes Service (AKS), and preview for AKS Engine and Azure Arc enabled Kubernetes. For instructions on using this policy, visit https://aka.ms/kubepolicydoc.",
        "metadata": {
            "version": "3.0.1",
            "category": "Kubernetes"
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "'Audit' allows a non-compliant resource to be created or updated, but flags it as non-compliant. 'Deny' blocks the non-compliant resource creation or update. 'Disabled' turns off the policy."
                },
                "allowedValues": [
                    "audit",
                    "deny",
                    "disabled"
                ],
                "defaultValue": "audit"
            },
            "excludedNamespaces": {
                "type": "Array",
                "metadata": {
                    "displayName": "Namespace exclusions",
                    "description": "List of Kubernetes namespaces to exclude from policy evaluation."
                },
                "defaultValue": [
                    "kube-system",
                    "gatekeeper-system",
                    "azure-arc"
                ]
            },
            "namespaces": {
                "type": "Array",
                "metadata": {
                  "displayName": "Namespace inclusions",
                  "description": "List of Kubernetes namespaces to only include in policy evaluation. An empty list means the policy is applied to all resources in all namespaces."
                },
                "defaultValue": []
            },
            "allowedSELinuxOptions": {
                "type": "Object",
                "metadata": {
                    "displayName": "Allowed SELinux options",
                    "description": "The allowed configurations for pod and container level SELinux Options. Provide empty options list as input to block everything.",
                    "schema": {
                        "type": "object",
                        "properties": {
                            "options": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "level": {
                                            "type": "string"
                                        },
                                        "role": {
                                            "type": "string"
                                        },
                                        "type": {
                                            "type": "string"
                                        },
                                        "user": {
                                            "type": "string"
                                        }
                                    },
                                    "additionalProperties": false
                                }
                            }
                        },
                        "required": [
                            "options"
                        ],
                        "additionalProperties": false
                    }
                },
                "defaultValue": {
                    "options": []
                }
            }
        },
        "policyRule": {
            "if": {
                "field": "type",
                "in": [
                    "AKS Engine",
                    "Microsoft.Kubernetes/connectedClusters"
                ]
            },
            "then": {
                "effect": "[parameters('effect')]",
                "details": {
                    "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/selinux/template.yaml",
                    "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/selinux/constraint.yaml",
                    "excludedNamespaces": "[parameters('excludedNamespaces')]",
                    "namespaces": "[parameters('namespaces')]",
                    "values": {
                        "excludedNamespaces": "[parameters('excludedNamespaces')]",
                        "allowedSELinuxOptions": "[parameters('allowedSELinuxOptions').options]"
                    }
                }
            }
        }
    },
    "id": "/providers/Microsoft.Authorization/policyDefinitions/e1e6c427-07d9-46ab-9689-bfa85431e636",
    "name": "e1e6c427-07d9-46ab-9689-bfa85431e636"
}